<script>
    const socket = io('/remote', {
        transports: ['polling', 'websocket'],
        upgrade: true,
        reconnection: true,
        reconnectionAttempts: Infinity,
        reconnectionDelay: 1000
    });

    const statusMsg = document.getElementById('status-msg');

    // --- State-Handling ---
    const COLORS = ['red', 'green', 'blue', 'yellow'];
    let lastUpdateTs = 0;

    // Cache, damit wir nicht sinnlos togglen
    const currentState = {
        red: 'off',
        green: 'off',
        blue: 'off',
        yellow: 'off'
    };

    function applyLedState(color, state) {
        const btn = document.getElementById('btn-' + color);
        if (!btn) return;

        const normalized = (state === 'on') ? 'on' : 'off';
        if (currentState[color] === normalized) return; // nichts zu tun

        currentState[color] = normalized;
        btn.classList.toggle('active', normalized === 'on');
        lastUpdateTs = Date.now();
    }

    function applySnapshot(states) {
        const s = states || {};
        COLORS.forEach((color) => {
            applyLedState(color, s[color] === 'on' ? 'on' : 'off');
        });
        lastUpdateTs = Date.now();
    }

    function requestLedSnapshot() {
        if (socket.connected) {
            socket.emit('request_led_snapshot');
        }
    }

    // --- Connection UI ---
    socket.on('connect', function() {
        console.log("Verbunden mit Pi-Remote");
        statusMsg.innerText = "Bereit zum Start";
        statusMsg.className = "text-success";
        requestLedSnapshot();
    });

    socket.on('disconnect', function() {
        statusMsg.innerText = "Verbindung verloren...";
        statusMsg.className = "text-warning";
    });

    socket.on('connect_error', function(err) {
        console.warn('Socket connect_error:', err && err.message ? err.message : err);
        statusMsg.innerText = "Verbindungsproblem...";
        statusMsg.className = "text-warning";
    });

    socket.on('reconnect', function() {
        statusMsg.innerText = "Wieder verbunden";
        statusMsg.className = "text-success";
        requestLedSnapshot();
    });

    // --- Server Events ---
    socket.on('status', function(data) {
        if (data && data.msg) {
            statusMsg.innerText = data.msg;
            statusMsg.className = "text-success";
        }
    });

    // Snapshot-Response
    socket.on('led_snapshot', function(data) {
        const states = data && data.states ? data.states : {};
        applySnapshot(states);
    });

    // Live-Updates (Event-basiert)
    socket.on('led_state', function(data) {
        if (data && data.color) {
            applyLedState(data.color, data.state);
        }
    });

    socket.on('game_status', function(data) {
        statusMsg.innerText = data.msg;
        statusMsg.className = "text-info";
    });

    socket.on('game_over', function(data) {
        statusMsg.innerText = "GAME OVER! Score: " + data.score;
        statusMsg.className = "text-danger";
        const board = document.querySelector('.game-board');
        board.style.boxShadow = "0 0 50px rgba(255,0,0,0.5)";
        setTimeout(() => {
            board.style.boxShadow = "0 20px 50px rgba(0,0,0,0.9)";
        }, 1000);
    });

    // --- Watchdog: nur wenn Updates ausbleiben, Snapshot nachziehen ---
    // Wenn 2.5s kein Update kam -> Snapshot
    setInterval(() => {
        if (!socket.connected) return;
        const now = Date.now();
        if (now - lastUpdateTs > 2500) {
            requestLedSnapshot();
        }
    }, 500);

    function sendInput(color) {
        // Deaktiviert: reine Live-Anzeige
        return;
    }

    function setDifficulty(level) {
        socket.emit('change_difficulty', {level: level});
    }
</script>
