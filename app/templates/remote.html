{% extends "base.html" %}

{% block title %}Simon Command Center{% endblock %}

{% block extra_css %}
<style>
    /*
     * RESET & BASICS
     */
    body,
    html {
        margin: 0;
        padding: 0;
        width: 100%;
        height: 100%;
        background-color: #1a1a1a;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        overflow: hidden;
        /* No scrollbars */
        user-select: none;
        /* No text selection */
        color: #ddd;
    }

    /*
     * MAIN CONTAINER
     * Holds the game board centered.
     */
    .simon-wrapper {
        position: fixed;
        /* Force full screen overlay */
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        z-index: 2000;
        /* Above navbar */
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        background: radial-gradient(circle at center, #2a2a2a 0%, #111 100%);
    }

    /* Add a close/back button since we cover the navbar */
    .back-btn {
        position: absolute;
        top: 20px;
        left: 20px;
        color: #888;
        text-decoration: none;
        font-size: 1.2rem;
        z-index: 2001;
        background: rgba(0, 0, 0, 0.5);
        padding: 5px 15px;
        border-radius: 20px;
        border: 1px solid #444;
    }

    .back-btn:hover {
        color: white;
        background: rgba(0, 0, 0, 0.8);
    }

    /*
     * THE GAME BOARD (THE WHEEL)
     */
    .game-board {
        position: relative;
        width: min(80vmin, 600px);
        height: min(80vmin, 600px);
        border-radius: 50%;
        background-color: #222;
        padding: 15px;
        /* Bezel thickness */
        box-shadow:
            0 0 0 2px #111,
            0 0 20px rgba(0, 0, 0, 0.5),
            inset 0 0 10px rgba(0, 0, 0, 0.8);
        box-sizing: border-box;
    }

    .game-board-inner {
        position: relative;
        width: 100%;
        height: 100%;
        border-radius: 50%;
        overflow: hidden;
        background-color: #111;
        box-shadow: inset 0 0 10px #000;
    }

    /*
     * THE BUTTONS
     */
    .simon-btn {
        position: absolute;
        width: 50%;
        height: 50%;
        opacity: 0.6;
        transition: all 0.1s ease;
        cursor: pointer;
        -webkit-tap-highlight-color: transparent;
        border: 4px solid #222;
        /* Gap between buttons */
        box-sizing: border-box;
    }

    /* Positioning the 4 quadrants */
    #btn-green {
        top: 0;
        left: 0;
        background-color: #00a74a;
        border-top-left-radius: 100%;
    }

    #btn-red {
        top: 0;
        right: 0;
        background-color: #9f0f17;
        border-top-right-radius: 100%;
    }

    #btn-yellow {
        bottom: 0;
        left: 0;
        background-color: #cca707;
        border-bottom-left-radius: 100%;
    }

    #btn-blue {
        bottom: 0;
        right: 0;
        background-color: #094a8f;
        border-bottom-right-radius: 100%;
    }

    /*
     * ACTIVE STATE (LIGHT UP)
     */
    .simon-btn.active#btn-green {
        background-color: #13ff7c;
        box-shadow: 0 0 30px #13ff7c;
        z-index: 10;
        opacity: 1;
    }

    .simon-btn.active#btn-red {
        background-color: #ff4c4c;
        box-shadow: 0 0 30px #ff4c4c;
        z-index: 10;
        opacity: 1;
    }

    .simon-btn.active#btn-yellow {
        background-color: #fed93f;
        box-shadow: 0 0 30px #fed93f;
        z-index: 10;
        opacity: 1;
    }

    .simon-btn.active#btn-blue {
        background-color: #1c8cff;
        box-shadow: 0 0 30px #1c8cff;
        z-index: 10;
        opacity: 1;
    }

    /* CENTER DECORATION */
    .center-decoration {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 35%;
        height: 35%;
        background: linear-gradient(135deg, #ddd, #aaa);
        border-radius: 50%;
        z-index: 50;
        border: 8px solid #222;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);

        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        text-align: center;
    }

    .brand-text {
        color: #222;
        font-weight: 900;
        font-size: min(4vmin, 24px);
        letter-spacing: 2px;
        text-transform: uppercase;
        margin-bottom: 5px;
        text-shadow: 1px 1px 0 rgba(255, 255, 255, 0.5);
    }

    /* STATUS INDICATOR (The logo/text inside) */
    #status-indicator {
        width: 12px;
        height: 12px;
        border-radius: 50%;
        background-color: #444;
        box-shadow: inset 1px 1px 2px rgba(0, 0, 0, 0.5);
        transition: background-color 0.3s;
        margin-top: 5px;
        border: 1px solid #888;
    }

    #status-indicator.connected {
        background-color: #00ff00;
        box-shadow: 0 0 10px #00ff00;
    }

    #status-indicator.disconnected {
        background-color: #ff0000;
        box-shadow: 0 0 10px #ff0000;
    }

    /*
     * CONTROLS (Difficulty)
     */
    .controls-container {
        margin-top: 30px;
        display: flex;
        gap: 15px;
        background: rgba(0, 0, 0, 0.3);
        padding: 10px 20px;
        border-radius: 30px;
        border: 1px solid #444;
    }

    .diff-btn {
        background-color: #333;
        color: #aaa;
        border: 1px solid #555;
        padding: 8px 16px;
        border-radius: 20px;
        font-size: 0.9rem;
        cursor: pointer;
        transition: all 0.2s;
        text-transform: uppercase;
        font-weight: bold;
        letter-spacing: 1px;
    }

    .diff-btn:hover {
        background-color: #444;
        color: #fff;
    }

    .diff-btn.active-diff {
        background-color: #0099cc;
        color: white;
        border-color: #00bfff;
        box-shadow: 0 0 10px rgba(0, 153, 204, 0.5);
    }
</style>
{% endblock %}

{% block content %}
<div class="simon-wrapper">
    <a href="/" class="back-btn">‚Üê Dashboard</a>
    <div class="game-board">
        <div class="game-board-inner">
            <div id="btn-green" class="simon-btn" data-color="green"></div>
            <div id="btn-red" class="simon-btn" data-color="red"></div>
            <div id="btn-yellow" class="simon-btn" data-color="yellow"></div>
            <div id="btn-blue" class="simon-btn" data-color="blue"></div>

            <div class="center-decoration">
                <div class="brand-text">SIMON</div>
                <div id="status-indicator" title="Connection Status"></div>
            </div>
        </div>
    </div>

    <div class="controls-container">
        {% for level in difficulty_settings.keys() %}
        <button class="diff-btn" data-level="{{ level }}" onclick="setDifficulty('{{ level }}')">
            {{ level }}
        </button>
        {% endfor %}
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- Socket.IO loaded from CDN to ensure we have a working client -->
<script src="https://cdn.socket.io/4.6.0/socket.io.min.js"
    integrity="sha384-c79GN5VsunZvi+Q/WObgk2in0CbZsHnjEqvFxC5DxHn9lTfNce2WW6h2pH6u/kF+"
    crossorigin="anonymous"></script>

<script>
    let socket;

    // Difficulty Setting Function (Global Scope)
    function setDifficulty(level) {
        if (socket && socket.connected) {
            console.log("Setting difficulty to:", level);
            socket.emit('change_difficulty', { level: level });
        }
    }

    document.addEventListener("DOMContentLoaded", () => {
        // --- 1. SETUP ---
        const STATUS_DOT = document.getElementById('status-indicator');
        const BUTTONS = {
            red: document.getElementById('btn-red'),
            green: document.getElementById('btn-green'),
            blue: document.getElementById('btn-blue'),
            yellow: document.getElementById('btn-yellow')
        };
        const DIFF_BTNS = document.querySelectorAll('.diff-btn');

        // --- 2. SOCKET CONNECTION ---
        // Connect specifically to the /remote namespace
        socket = io('/remote', {
            transports: ['websocket', 'polling']
        });

        // --- 3. EVENT HANDLERS ---

        socket.on('connect', () => {
            console.log("Remote: Connected to server.");
            STATUS_DOT.classList.remove('disconnected');
            STATUS_DOT.classList.add('connected');

            // Immediately ask for current state
            socket.emit('request_led_snapshot');
        });

        socket.on('disconnect', () => {
            console.warn("Remote: Disconnected from server.");
            STATUS_DOT.classList.remove('connected');
            STATUS_DOT.classList.add('disconnected');
        });

        socket.on('connect_error', (err) => {
            console.error("Remote: Connection Error:", err);
            STATUS_DOT.classList.remove('connected');
            STATUS_DOT.classList.add('disconnected');
        });

        socket.on('difficulty_changed', (data) => {
            console.log("Difficulty changed:", data.level);
            DIFF_BTNS.forEach(btn => {
                if (btn.dataset.level === data.level) {
                    btn.classList.add('active-diff');
                } else {
                    btn.classList.remove('active-diff');
                }
            });
        });

        // --- 4. GAME LOGIC ---

        function setLight(color, isOn) {
            const btn = BUTTONS[color];
            if (!btn) return;

            if (isOn) {
                btn.classList.add('active');
            } else {
                btn.classList.remove('active');
            }
        }

        // Handle single updates (Realtime)
        socket.on('led_state', (data) => {
            // Expecting: {color: 'red', state: 'on'/'off' or true/false}
            if (data && data.color) {
                const isOn = (data.state === 'on' || data.state === true);
                setLight(data.color, isOn);
            }
        });

        // Handle bulk updates (Snapshots)
        socket.on('led_snapshot', (data) => {
            const states = (data && data.states) ? data.states : {};
            ['red', 'green', 'blue', 'yellow'].forEach(color => {
                const val = states[color];
                const isOn = (val === 'on' || val === true);
                setLight(color, isOn);
            });
        });


        // --- 5. INTERACTION ---

        function handleInput(e) {
            // Prevent zooming or scrolling
            e.preventDefault();

            const color = this.getAttribute('data-color');
            if (socket.connected && color) {
                // Visual feedback instantly for better feel
                this.classList.add('active');
                setTimeout(() => this.classList.remove('active'), 200);

                console.log(`Remote: Sending input '${color}'`);
                socket.emit('remote_input', { color: color });
            }
        }

        Object.values(BUTTONS).forEach(btn => {
            // Support both Touch and Mouse
            btn.addEventListener('touchstart', handleInput, { passive: false });
            btn.addEventListener('mousedown', handleInput);
        });

        // --- 6. WATCHDOG (Polling) ---
        // Every 1s, ask server "How do the lights look?" 
        setInterval(() => {
            if (socket.connected) {
                socket.emit('request_led_snapshot');
            }
        }, 1000);

    });
</script>
{% endblock %}