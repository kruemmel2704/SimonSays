{% extends "base.html" %}

{% block title %}Simon Remote{% endblock %}

{% block extra_css %}
<style>
    /* 
     * KIOSK MODE / FULL SCREEN STYLE 
     * Zentriert, dunkel, Fokus nur auf dem Spielrad.
     */
    body,
    html {
        margin: 0;
        padding: 0;
        height: 100%;
        overflow: hidden;
        /* Scrollbars weg */
        background-color: #121212;
    }

    /* Der Container füllt den Bildschirm und zentriert alles */
    .simon-wrapper {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        height: 100vh;
        width: 100vw;
    }

    /* Das Spielrad */
    .game-board {
        position: relative;
        width: 80vmin;
        /* 80% der kleineren Bildschirmseite */
        height: 80vmin;
        border-radius: 50%;
        background-color: #222;
        border: 10px solid #333;
        box-shadow: 0 0 50px rgba(0, 0, 0, 0.8);
        overflow: hidden;
        /* Damit die Sektoren nicht überstehen */
        display: grid;
        grid-template-columns: 1fr 1fr;
        grid-template-rows: 1fr 1fr;
        gap: 2%;
        /* Lücke zwischen den Tasten */
        padding: 2%;
        box-sizing: border-box;
    }

    /* Die 4 Farbfelder */
    .simon-btn {
        width: 100%;
        height: 100%;
        opacity: 0.3;
        /* Standard: dunkel/aus */
        transition: opacity 0.1s, transform 0.1s;
        cursor: pointer;
        /* Verhindert "Auswählen" beim wilden Klicken */
        -webkit-tap-highlight-color: transparent;
        user-select: none;
    }

    .simon-btn:active {
        transform: scale(0.95);
    }

    /* Farben & Formen */
    #btn-green {
        background-color: #00ff00;
        border-top-right-radius: 100%;
    }

    #btn-red {
        background-color: #ff0000;
        border-top-left-radius: 100%;
    }

    #btn-yellow {
        background-color: #ffff00;
        border-bottom-left-radius: 100%;
    }

    #btn-blue {
        background-color: #0000ff;
        border-bottom-right-radius: 100%;
    }

    /* AKTIVER ZUSTAND (LEUCHTEN) */
    .simon-btn.active {
        opacity: 1;
        box-shadow: 0 0 30px currentColor;
        /* Leuchtet in eigener Farbe */
        z-index: 10;
        /* Leuchten soll über andere Elemente strahlen */
    }

    /* Kleiner Verbindungs-Status unten rechts (dezenter Punkt) */
    #conn-status {
        position: absolute;
        bottom: 20px;
        right: 20px;
        width: 10px;
        height: 10px;
        border-radius: 50%;
        background-color: #333;
        /* Default: Disconnected */
        box-shadow: 0 0 5px rgba(0, 0, 0, 0.5);
    }

    #conn-status.connected {
        background-color: #00ff00;
        box-shadow: 0 0 10px #00ff00;
    }

    #conn-status.disconnected {
        background-color: #ff0000;
    }
</style>
{% endblock %}

{% block content %}
<div class="simon-wrapper">
    <div class="game-board">
        <!-- Reihenfolge im Grid beachten: -->
        <!-- Oben Links: Rot -->
        <div id="btn-red" class="simon-btn" data-color="red"></div>
        <!-- Oben Rechts: Grün -->
        <div id="btn-green" class="simon-btn" data-color="green"></div>
        <!-- Unten Links: Blau -->
        <div id="btn-blue" class="simon-btn" data-color="blue"></div>
        <!-- Unten Rechts: Gelb -->
        <div id="btn-yellow" class="simon-btn" data-color="yellow"></div>
    </div>

    <!-- Dezenter Verbindungs-Indikator -->
    <div id="conn-status" title="Status"></div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
<script>
    document.addEventListener("DOMContentLoaded", () => {
        // Verbindung zum Namespace /remote herstellen
        const socket = io('/remote', {
            transports: ['websocket', 'polling'], // Websocket bevorzugen
            reconnection: true,
            reconnectionDelay: 500,
            reconnectionAttempts: Infinity
        });

        const statusDot = document.getElementById('conn-status');
        const buttons = {
            red: document.getElementById('btn-red'),
            green: document.getElementById('btn-green'),
            blue: document.getElementById('btn-blue'),
            yellow: document.getElementById('btn-yellow')
        };

        // --- HILFSFUNKTIONEN ---

        function setLedColor(color, isOn) {
            const btn = buttons[color];
            if (btn) {
                if (isOn) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            }
        }

        function updateAll(states) {
            if (!states) return;
            for (const [color, state] of Object.entries(states)) {
                setLedColor(color, state === 'on' || state === true);
            }
        }

        // --- SOCKET EVENT LISTENER ---

        socket.on('connect', () => {
            console.log('Verunden mit /remote');
            statusDot.classList.remove('disconnected');
            statusDot.classList.add('connected');
            // Sofort Update anfordern
            socket.emit('request_led_snapshot');
        });

        socket.on('disconnect', () => {
            console.log('Verbindung verloren');
            statusDot.classList.remove('connected');
            statusDot.classList.add('disconnected');
        });

        // 1. EVENT: Einzelne LED ändert sich (Echtzeit)
        socket.on('led_state', (data) => {
            // data = {color: 'red', state: 'on'}
            if (data && data.color) {
                const isOn = (data.state === 'on' || data.state === true);
                setLedColor(data.color, isOn);
            }
        });

        // 2. EVENT: Komplettes Update (z.B. beim Neuladen)
        socket.on('led_snapshot', (data) => {
            // data = {states: {red: 'off', green: 'on', ...}}
            if (data && data.states) {
                updateAll(data.states);
            }
        });

        // 3. EVENT: Game Over (Optional: Alles kurz rot blinken lassen)
        socket.on('game_over', () => {
            document.querySelector('.game-board').style.borderColor = 'red';
            setTimeout(() => {
                document.querySelector('.game-board').style.borderColor = '#333';
            }, 500);
        });


        // --- POLLING / WATCHDOG (Für Robustheit) ---
        // Fragt alle 500ms aktiv nach dem Status, falls ein Paket verloren ging
        setInterval(() => {
            if (socket.connected) {
                socket.emit('request_led_snapshot');
            }
        }, 500); // 2x pro Sekunde syncen


        // --- INTERAKTION (Mausklick / Touch) ---
        // Sendet Eingaben an den Server
        Object.values(buttons).forEach(btn => {
            btn.addEventListener('mousedown', sendClick);
            btn.addEventListener('touchstart', sendClick);
        });

        function sendClick(e) {
            e.preventDefault(); // Verhindert z.B. Zoom auf Tatsch
            const color = this.getAttribute('data-color');
            if (socket.connected && color) {
                socket.emit('remote_input', { color: color });

                // Visuelles Feedback sofort (für bessere Responsiveness)
                // Der Server schickt zwar ein 'led_state', aber lokal wirkt es schneller.
                // Wir lassen es nur kurz aufleuchten.
                // (Optional: Wenn der Server-Logic das Licht steuert, kann man das hier weglassen,
                // damit man sieht, was der Server "denkt".)
            }
        }
    });
</script>
{% endblock %}