{% extends "base.html" %}

{% block title %}Simon Command Center{% endblock %}

{% block extra_css %}
<style>
    /*
     * RESET & BASICS
     */
    body,
    html {
        margin: 0;
        padding: 0;
        width: 100%;
        height: 100%;
        background-color: #1a1a1a;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        overflow: hidden;
        /* No scrollbars */
        user-select: none;
        /* No text selection */
        color: #ddd;
    }

    /*
     * MAIN CONTAINER
     * Holds the game board centered.
     */
    /*
     * MAIN CONTAINER
     * Holds the game board centered.
     */
    .simon-wrapper {
        position: relative;
        width: 100%;
        min-height: 80vh;
        /* Fill rest of screen roughly */
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        /* Keep the cool background but bounded */
    }

    /* Back button removed as we now use the Navbar */

    /*
     * THE GAME BOARD (THE WHEEL)
     */
    .game-board {
        position: relative;
        width: min(70vmin, 500px);
        /* Slightly smaller to fit in container */
        height: min(70vmin, 500px);
        border-radius: 50%;
        background-color: #222;
        padding: 15px;
        /* Bezel thickness */
        box-shadow:
            0 0 0 2px #111,
            0 0 20px rgba(0, 0, 0, 0.5),
            inset 0 0 10px rgba(0, 0, 0, 0.8);
        box-sizing: border-box;
    }

    .game-board-inner {
        position: relative;
        width: 100%;
        height: 100%;
        border-radius: 50%;
        overflow: hidden;
        background-color: #111;
        box-shadow: inset 0 0 10px #000;
    }

    /*
     * THE BUTTONS
     */
    .simon-btn {
        position: absolute;
        width: 50%;
        height: 50%;
        opacity: 0.6;
        transition: all 0.1s ease;
        cursor: pointer;
        -webkit-tap-highlight-color: transparent;
        border: 4px solid #222;
        /* Gap between buttons */
        box-sizing: border-box;
    }

    /* Positioning the 4 quadrants */
    #btn-green {
        top: 0;
        left: 0;
        background-color: #00a74a;
        border-top-left-radius: 100%;
    }

    #btn-red {
        top: 0;
        right: 0;
        background-color: #9f0f17;
        border-top-right-radius: 100%;
    }

    #btn-yellow {
        bottom: 0;
        left: 0;
        background-color: #cca707;
        border-bottom-left-radius: 100%;
    }

    #btn-blue {
        bottom: 0;
        right: 0;
        background-color: #094a8f;
        border-bottom-right-radius: 100%;
    }

    /*
     * ACTIVE STATE (LIGHT UP)
     */
    .simon-btn.active#btn-green {
        background-color: #13ff7c;
        box-shadow: 0 0 30px #13ff7c;
        z-index: 10;
        opacity: 1;
    }

    .simon-btn.active#btn-red {
        background-color: #ff4c4c;
        box-shadow: 0 0 30px #ff4c4c;
        z-index: 10;
        opacity: 1;
    }

    .simon-btn.active#btn-yellow {
        background-color: #fed93f;
        box-shadow: 0 0 30px #fed93f;
        z-index: 10;
        opacity: 1;
    }

    .simon-btn.active#btn-blue {
        background-color: #1c8cff;
        box-shadow: 0 0 30px #1c8cff;
        z-index: 10;
        opacity: 1;
    }

    /* CENTER DECORATION */
    .center-decoration {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 35%;
        height: 35%;
        background: linear-gradient(135deg, #ddd, #aaa);
        border-radius: 50%;
        z-index: 50;
        border: 8px solid #222;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);

        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        text-align: center;
    }

    .brand-text {
        color: #222;
        font-weight: 900;
        font-size: min(4vmin, 24px);
        letter-spacing: 2px;
        text-transform: uppercase;
        margin-bottom: 5px;
        text-shadow: 1px 1px 0 rgba(255, 255, 255, 0.5);
    }

    /* STATUS INDICATOR (The logo/text inside) */
    #status-indicator {
        width: 12px;
        height: 12px;
        border-radius: 50%;
        background-color: #444;
        box-shadow: inset 1px 1px 2px rgba(0, 0, 0, 0.5);
        transition: background-color 0.3s;
        margin-top: 5px;
        border: 1px solid #888;
    }

    #status-indicator.connected {
        background-color: #00ff00;
        box-shadow: 0 0 10px #00ff00;
    }

    #status-indicator.disconnected {
        background-color: #ff0000;
        box-shadow: 0 0 10px #ff0000;
    }

    /*
     * CONTROLS (Difficulty)
     */
    .controls-container {
        margin-top: 30px;
        display: flex;
        gap: 15px;
        background: rgba(0, 0, 0, 0.3);
        padding: 10px 20px;
        border-radius: 30px;
        border: 1px solid #444;
    }

    .diff-btn {
        background-color: #333;
        color: #aaa;
        border: 1px solid #555;
        padding: 8px 16px;
        border-radius: 20px;
        font-size: 0.9rem;
        cursor: pointer;
        transition: all 0.2s;
        text-transform: uppercase;
        font-weight: bold;
        letter-spacing: 1px;
    }

    .diff-btn:hover {
        background-color: #444;
        color: #fff;
    }

    .diff-btn.active-diff {
        background-color: #0099cc;
        color: white;
        border-color: #00bfff;
        box-shadow: 0 0 10px rgba(0, 153, 204, 0.5);
    }
</style>
{% endblock %}

{% block content %}
<div class="simon-wrapper">
    <!-- Back button removed (Navbar is used) -->
    <div class="game-board">
        <div class="game-board-inner">
            <div id="btn-green" class="simon-btn" data-color="green"></div>
            <div id="btn-red" class="simon-btn" data-color="red"></div>
            <div id="btn-yellow" class="simon-btn" data-color="yellow"></div>
            <div id="btn-blue" class="simon-btn" data-color="blue"></div>

            <div class="center-decoration">
                <div class="brand-text">SIMON</div>
                <div id="status-indicator" title="Connection Status"></div>
            </div>
        </div>
    </div>

    <div class="controls-container">
        {% for level in difficulty_settings.keys() %}
        <button class="diff-btn" data-level="{{ level }}" onclick="setDifficulty('{{ level }}')">
            {{ level }}
        </button>
        {% endfor %}
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- Socket.IO loaded from CDN to ensure we have a working client -->
<script src="https://cdn.socket.io/4.6.0/socket.io.min.js"
    integrity="sha384-c79GN5VsunZvi+Q/WObgk2in0CbZsHnjEqvFxC5DxHn9lTfNce2WW6h2pH6u/kF+"
    crossorigin="anonymous"></script>
<!-- Highscore Entry Modal -->
<div class="modal fade" id="nameInputModal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1"
    aria-hidden="true" style="z-index: 10000;">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content bg-dark text-white border-info">
            <div class="modal-header border-secondary">
                <h5 class="modal-title font-orbitron">Game Over!</h5>
            </div>
            <div class="modal-body text-center">
                <p class="lead">Score: <span id="final-score" class="fw-bold text-warning">0</span></p>
                <p>Save your Highscore:</p>
                <form id="name-form">
                    <div class="mb-3">
                        <input type="text" class="form-control bg-secondary text-white border-0 text-center"
                            id="player-name" placeholder="YOUR NAME" required autocomplete="off">
                    </div>
                    <div class="d-grid">
                        <button type="submit" class="btn btn-info fw-bold">SAVE & RESTART</button>
                        <a href="/" class="btn btn-outline-light mt-2 btn-sm">View Highscores</a>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Scripts -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.socket.io/4.6.0/socket.io.min.js"></script>
<script>
    const socket = io('/remote');
    // Globaler Socket für den default namespace (für Highscore-Submit)
    // Wir erzeugen ihn EINMAL, nicht bei jedem Submit, um Ressourcen zu sparen.
    const defaultSocket = io('/');

    // Setup Visuals
    const gameBoard = document.querySelector('.game-board');
    const SIMON_BTNS = {
        'green': document.getElementById('btn-green'),
        'red': document.getElementById('btn-red'),
        'yellow': document.getElementById('btn-yellow'),
        'blue': document.getElementById('btn-blue')
    };
    const DIFF_BTNS = document.querySelectorAll('.diff-btn');
    const STATUS_DOT = document.getElementById('status-indicator');

    // Modal Elements
    const modalElement = document.getElementById('nameInputModal');
    const modal = new bootstrap.Modal(modalElement);
    const nameForm = document.getElementById('name-form');
    const nameInput = document.getElementById('player-name');
    const scoreDisplay = document.getElementById('final-score');
    // const debugLog = document.getElementById('debug-log'); // Removed

    function log(msg) {
        console.log(msg);
    }

    // State
    let isNameInputActive = false;

    // Difficulty Handling
    function setDifficulty(level) {
        log("Setting difficulty to: " + level);
        if (socket && socket.connected) {
            socket.emit('change_difficulty', { level: level });
        } else {
            log("Error: Socket not connected");
        }
    }

    document.addEventListener("DOMContentLoaded", () => {
        // Socket Events
        socket.on('connect', () => {
            log("Socket Connected! ID: " + socket.id);
            STATUS_DOT.classList.remove('disconnected');
            STATUS_DOT.classList.add('connected');
            socket.emit('request_snapshot');
        });

        socket.on('disconnect', () => {
            log("Socket Disconnected!");
            STATUS_DOT.classList.remove('connected');
            STATUS_DOT.classList.add('disconnected');
        });

        socket.on('connect_error', (error) => {
            log("Socket Connection Error: " + error.message);
            STATUS_DOT.classList.remove('connected');
            STATUS_DOT.classList.add('disconnected');
        });

        socket.on('led_state', (data) => {
            // log(`LED State: ${data.color} -> ${data.state}`);
            const btn = SIMON_BTNS[data.color];
            if (btn) {
                if (data.state === 'on') {
                    btn.classList.add('active');
                    // log(`${data.color} ON`);
                } else {
                    btn.classList.remove('active');
                }
            }
        });

        socket.on('led_snapshot', (leds) => {
            log("Received LED Snapshot");
            for (const [color, state] of Object.entries(leds)) {
                const btn = SIMON_BTNS[color];
                if (btn) {
                    if (state === 'on') btn.classList.add('active');
                    else btn.classList.remove('active');
                }
            }
        });

        socket.on('difficulty_changed', (data) => {
            log("Difficulty changed to: " + data.level);
            DIFF_BTNS.forEach(btn => {
                if (btn.dataset.level === data.level) {
                    btn.classList.add('active-diff');
                } else {
                    btn.classList.remove('active-diff');
                }
            });
        });

        // Name Input Logic
        socket.on('request_name', (data) => {
            log("Request Name Event received! Score: " + data.score);
            scoreDisplay.textContent = data.score;

            // Prevent double opening
            if (!isNameInputActive && !modalElement.classList.contains('show')) {
                isNameInputActive = true;
                nameInput.value = '';
                modal.show();
                setTimeout(() => nameInput.focus(), 500);
            }
        });

        // Handle Input Submission
        nameForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const name = nameInput.value.trim();
            if (name) {
                // Nutze globalen Socket
                defaultSocket.emit('submit_highscore', { name: name });

                modal.hide();
                isNameInputActive = false; // Reset flag
            }
        });

        // Button Clicks
        Object.entries(SIMON_BTNS).forEach(([color, btn]) => {
            const handleInput = (e) => {
                // Prevent default to avoid double-firing on some touch devices
                if (e.type === 'touchstart') e.preventDefault();

                log(`Input: ${color} (Socket: ${socket.connected})`);

                // Visual feedback immediately
                btn.classList.add('active');
                setTimeout(() => btn.classList.remove('active'), 200);

                if (socket.connected) {
                    socket.emit('remote_input', { color: color });
                } else {
                    log("Cannot send: Disconnected");
                }
            };
            // Use mousedown for desktop, touchstart for mobile
            btn.addEventListener('mousedown', (e) => {
                // Ignore mousedown if we just processed a touchstart (rare but possible)
                handleInput(e);
            });
            btn.addEventListener('touchstart', handleInput, { passive: false });
        });

        // Difficulty Buttons
        DIFF_BTNS.forEach(btn => {
            btn.addEventListener('click', () => {
                setDifficulty(btn.dataset.level);
            });
        });

        // --- 6. WATCHDOG (Polling) ---
        // Every 1s, ask server "How do the lights look?"
        setInterval(() => {
            if (socket.connected) {
                socket.emit('request_led_snapshot');
            }
        }, 1000);

    });
</script>
{% endblock %}