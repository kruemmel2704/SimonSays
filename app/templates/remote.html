{% extends "base.html" %}

{% block title %}Simon Remote{% endblock %}

{% block extra_css %}
<style>
    /*
     * RESET & BASICS
     */
    body,
    html {
        margin: 0;
        padding: 0;
        width: 100%;
        height: 100%;
        background-color: #111;
        font-family: sans-serif;
        overflow: hidden;
        /* No scrollbars */
        user-select: none;
        /* No text selection */
    }

    /*
     * MAIN CONTAINER
     * Holds the game board centered.
     */
    .simon-wrapper {
        position: relative;
        width: 100vw;
        height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    /*
     * THE GAME BOARD (THE WHEEL)
     * Fixed aspect ratio, responsive size.
     */
    .game-board {
        position: relative;
        width: 80vmin;
        /* 80% of viewport min dimension */
        height: 80vmin;
        border-radius: 50%;
        background-color: #222;
        border: 4px solid #333;
        box-shadow: 0 0 50px rgba(0, 0, 0, 0.8);

        /* 
         IMPORTANT: We use a container internal to the board 
         to hold the absolute positioned buttons.
        */
        box-sizing: border-box;
    }

    /*
     * THE BUTTONS
     * Absolute positioning to ensure they form a perfect 4-part circle.
     * Each button takes up 50% width/height minus a small gap.
     */
    .simon-btn {
        position: absolute;
        width: 48%;
        /* 50% minus 2% gap space */
        height: 48%;
        opacity: 0.25;
        transition: opacity 0.1s;
        cursor: pointer;
        -webkit-tap-highlight-color: transparent;
    }

    /* Positioning the 4 quadrants */
    #btn-red {
        top: 0;
        left: 0;
        background-color: #ff0000;
        border-top-left-radius: 100% 100%;
        /* Perfect quarter circle */
    }

    #btn-green {
        top: 0;
        right: 0;
        background-color: #00ff00;
        border-top-right-radius: 100% 100%;
    }

    #btn-blue {
        bottom: 0;
        left: 0;
        background-color: #0000ff;
        border-bottom-left-radius: 100% 100%;
    }

    #btn-yellow {
        bottom: 0;
        right: 0;
        background-color: #ffff00;
        border-bottom-right-radius: 100% 100%;
    }

    /*
     * ACTIVE STATE (LIGHT UP)
     */
    .simon-btn.active {
        opacity: 1 !important;
        box-shadow: 0 0 40px currentColor;
        /* Glow in its own color */
        z-index: 100;
    }

    /* CENTER CIRCLE (Optional styling to make it look like the toy) */
    .center-decoration {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 30%;
        height: 30%;
        background-color: #111;
        border-radius: 50%;
        z-index: 50;
        border: 4px solid #333;

        /* Display connection indicator inside */
        display: flex;
        align-items: center;
        justify-content: center;
    }

    /* STATUS INDICATOR (The logo/text inside) */
    #status-indicator {
        width: 15px;
        height: 15px;
        border-radius: 50%;
        background-color: #444;
        /* Grey = connecting */
        box-shadow: 0 0 5px rgba(255, 255, 255, 0.1);
        transition: background-color 0.3s;
    }

    #status-indicator.connected {
        background-color: #00ff00;
        box-shadow: 0 0 10px #00ff00;
    }

    #status-indicator.disconnected {
        background-color: #ff0000;
        box-shadow: 0 0 10px #ff0000;
    }
</style>
{% endblock %}

{% block content %}
<div class="simon-wrapper">
    <div class="game-board">
        <div id="btn-red" class="simon-btn" data-color="red"></div>
        <div id="btn-green" class="simon-btn" data-color="green"></div>
        <div id="btn-blue" class="simon-btn" data-color="blue"></div>
        <div id="btn-yellow" class="simon-btn" data-color="yellow"></div>

        <div class="center-decoration">
            <div id="status-indicator" title="Connection Status"></div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- Socket.IO loaded from CDN to ensure we have a working client -->
<script src="https://cdn.socket.io/4.6.0/socket.io.min.js"
    integrity="sha384-c79GN5VsunZvi+Q/WObgk2in0CbZsHnjEqvFxC5DxHn9lTfNce2WW6h2pH6u/kF+"
    crossorigin="anonymous"></script>

<script>
    document.addEventListener("DOMContentLoaded", () => {
        // --- 1. SETUP ---
        const STATUS_DOT = document.getElementById('status-indicator');
        const BUTTONS = {
            red: document.getElementById('btn-red'),
            green: document.getElementById('btn-green'),
            blue: document.getElementById('btn-blue'),
            yellow: document.getElementById('btn-yellow')
        };

        // --- 2. SOCKET CONNECTION ---
        // Connect specifically to the /remote namespace
        const socket = io('/remote', {
            transports: ['websocket', 'polling']
        });

        // --- 3. EVENT HANDLERS ---

        socket.on('connect', () => {
            console.log("Remote: Connected to server.");
            STATUS_DOT.classList.remove('disconnected');
            STATUS_DOT.classList.add('connected');

            // Immediately ask for current state
            socket.emit('request_led_snapshot');
        });

        socket.on('disconnect', () => {
            console.warn("Remote: Disconnected from server.");
            STATUS_DOT.classList.remove('connected');
            STATUS_DOT.classList.add('disconnected');
        });

        socket.on('connect_error', (err) => {
            console.error("Remote: Connection Error:", err);
            STATUS_DOT.classList.remove('connected');
            STATUS_DOT.classList.add('disconnected');
        });

        // --- 4. GAME LOGIC ---

        function setLight(color, isOn) {
            const btn = BUTTONS[color];
            if (!btn) return;

            if (isOn) {
                btn.classList.add('active');
            } else {
                btn.classList.remove('active');
            }
        }

        // Handle single updates (Realtime)
        socket.on('led_state', (data) => {
            // Expecting: {color: 'red', state: 'on'/'off' or true/false}
            console.log("Remote: Event 'led_state'", data);
            if (data && data.color) {
                const isOn = (data.state === 'on' || data.state === true);
                setLight(data.color, isOn);
            }
        });

        // Handle bulk updates (Snapshots)
        socket.on('led_snapshot', (data) => {
            console.log("Remote: Event 'led_snapshot'", data);
            const states = (data && data.states) ? data.states : {};

            ['red', 'green', 'blue', 'yellow'].forEach(color => {
                const val = states[color];
                const isOn = (val === 'on' || val === true);
                setLight(color, isOn);
            });
        });


        // --- 5. INTERACTION ---

        function handleInput(e) {
            // Prevent zooming or scrolling
            e.preventDefault();

            const color = this.getAttribute('data-color');
            if (socket.connected && color) {
                console.log(`Remote: Sending input '${color}'`);
                socket.emit('remote_input', { color: color });

                // Optional: Instant local feedback (visual only)
                // setLight(color, true);
                // setTimeout(() => setLight(color, false), 200);
            }
        }

        Object.values(BUTTONS).forEach(btn => {
            // Support both Touch and Mouse
            btn.addEventListener('touchstart', handleInput, { passive: false });
            btn.addEventListener('mousedown', handleInput);
        });

        // --- 6. WATCHDOG (Polling) ---
        // Every 500ms, ask server "How do the lights look?" 
        // This fixes missed packets.
        setInterval(() => {
            if (socket.connected) {
                socket.emit('request_led_snapshot');
            }
        }, 500);

    });
</script>
{% endblock %}